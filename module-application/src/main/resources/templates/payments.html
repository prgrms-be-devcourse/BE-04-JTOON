<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Sample Payment</title>

    <!-- jQuery -->
    <script type="text/javascript"
            src="https://code.jquery.com/jquery-1.12.4.min.js"></script>

    <!-- iamport.payment.js -->
    <script type="text/javascript"
            src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js">
    </script>

    <script>
        $("#payment-form").on('submit', function (e) {

            // <form> 태그의 onsubmit 이벤트 핸들러에서 e.preventDefault();를 호출하여 기본 제출 동작을 중단.
            // 대신에 IMP.request_pay() 함수를 호출 즉, 페이지를 새로고침하는 대신 AJAX 요청을 보내고 싶다면 사용한다.
            e.preventDefault();

            var IMP = window.IMP;
            var buyerName = $("#buyer-name").val();
            var buyerEmail = $("#buyer-email").val();
            var buyerTel = $("#buyer-tel").val();
            var amount = $("#amount").val();
            var productName = $("#product-name").val();

            IMP.init("imp12345678");
            IMP.request_pay({
                pg: 'html5_inicis',
                pay_method: 'card',
                merchant_uid: "IMP" + new Date().getTime(),
                name: productName,
                amount: amount,
                buyer_email: buyerEmail,
                buyer_name: buyerName,
                buyer_tel: buyerTel
            }, function (rsp) {
                // 결제 성공 시
                if (rsp.success) {
                    uid = rsp.imp_uid;
                    // 결제 성공 시, 서버로 해당 정보로 검증 및 주문서 생성 요청
                    $.ajax({
                        url: '/api/v1/payments/' + rsp.imp_uid,
                        method: 'POST',
                        contentType: "application/json",
                        data: JSON.stringify({
                            imp_uid: rsp.imp_uid,
                            pg: rsp.pg,
                            pay_method: rsp.pay_method,
                            merchant_uid: rsp.merchant_uid,
                            name: rsp.name,
                            amount: rsp.amount,
                            buyer_email: rsp.buyer_email,
                            buyer_name: rsp.buyer_name,
                            buyer_tel: rsp.buyer_tel
                        })
                    }).done(function (data) {
                        // 혹시 모르니 한 번 더 검증
                        if (amount == data.amount) {
                            alert('결제 성공');
                        } else {
                            // 실패 시, 결제 취소 요청
                            alert('결제 실패 : ' + rsp.error_msg);
                        }
                    })
                } else {
                    alert('결제 실패' + rsp.error_msg);
                }
            });
        });
    </script>
</head>
<body>
<form id="payment-form">
    이름: <input type="text" id="buyer-name"><br>
    이메일: <input type="text" id="buyer-email"><br>
    전화번호: <input type="text" id="buyer-tel"><br>
    금액: <input type='number' id='amount'><br>
    상품명: <input type='text' id='product-name'><br>

    <!-- 결제하기 버튼을 form의 submit 버튼으로 변경 -->
    <button type='submit'>결제하기</button>
</form>
</body>
</html>
